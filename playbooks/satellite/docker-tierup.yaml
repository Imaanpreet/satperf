---
- hosts: docker-hosts
  remote_user: root
  roles:
  ###  - common
  tasks:
    - name: "Containes started"
      shell: |
        [ -d "/tmp/yum-cache/{{ item }}/" ] || mkdir "/tmp/yum-cache/{{ item }}/"
        docker run -h "{{ ansible_hostname }}container{{ item }}.example.com" -d -v "/tmp/yum-cache/{{ item }}/:/var/cache/yum/" r7perfsat
      with_sequence:
        count=100
    - name: "List container IDs"
      command:
        docker ps -q
      register: docker_ids
    - name: "Get IPs of containers"
      shell:
        docker inspect "{{ item }}" | python -c "import json,sys;obj=json.load(sys.stdin);print obj[0]['Id'], obj[0]['NetworkSettings']['IPAddress']"
      with_items: "{{ docker_ids.stdout_lines }}"
      register: docker_ips
    - name: "Cleanup container IPs list locally"
      file:
        path=/root/container-ips
        state=absent
      delegate_to: 127.0.0.1
      run_once: true
    # TODO: rewrite this into inventory - would shuffling work?
    - name: "Save container IPs"
      shell:
        echo "{{ item.stdout }}" >>/root/container-ips
      with_items: "{{ docker_ips.results }}"
      delegate_to: 127.0.0.1
    - name: "Shuffle container IPs"
      shell:
        sort -R /root/container-ips >/root/container-ips.shuffled
      delegate_to: 127.0.0.1
      run_once: true
