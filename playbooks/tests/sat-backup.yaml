- hosts: satellite6
  remote_user: root
  tasks:
    - name: create a dir for backup & give full permission to postgres user
      file:
        path: "{{ item }}"
        state: directory
        mode: 0775
        owner: postgres
      loop:
        - /backup-offline
        - /backup-online

    - name: execute the Satellite online backup
      command: satellite-maintain backup online -y /backup-online/
      register: backup_online_cmd

    - name: print online backup duration
      debug:
        msg: "BackupOnline {{ backup_online_cmd.start }} to {{ backup_online_cmd.end }}"
      when: "backup_online_cmd.rc is defined and backup_online_cmd.rc == 0"

    - name: execute the Satellite offline backup
      command: satellite-maintain backup offline -y /backup-offline/
      register: backup_offline_cmd

    - name: print offline backup duration
      debug:
        msg: "BackupOffline {{ backup_offline_cmd.start }} to {{ backup_offline_cmd.end }}"
      when: "backup_offline_cmd.rc is defined and backup_offline_cmd.rc == 0"

    - name: cleanup directory
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /backup-offline
        - /backup-online
