---
- hosts: container_hosts
  remote_user: root
  gather_facts: no
  vars_files:
    - ../../conf/satperf.yaml
    - ../../conf/satperf.local.yaml
  vars:
    method: "clients.yaml"
    size: 10   # TODO: would be nice to provide total expected number and that would be divided by number of container hosts
    resting: 0
    num_retry_forks: 3
    registration_logs: "registration_logs"
  tasks:
    - name: "Check whether we have already registered some containers"
      ansible.builtin.stat:
        path: /root/container-used-count
      register: container_used_count_path

    - name: "Set number of used containers to 0"
      ansible.builtin.set_fact:
        containers_used_count: 0
      when: "not container_used_count_path.stat.exists"

    - name: "Load number of already registered containers"
      ansible.builtin.command:
        cmd: cat /root/container-used-count
      register: containers_used_count_cmd
      ignore_errors: true
      when: "container_used_count_path.stat.exists"

    - name: "Set number of used containers based on file contents"
      ansible.builtin.set_fact:
        containers_used_count: "{{ containers_used_count_cmd.stdout }}"   # Warning: this is still a string: https://github.com/ansible/ansible/issues/15249
      when: "container_used_count_path.stat.exists"

    - name: "Ensure we have enough free containers"
      ansible.builtin.assert:
        that: "containers_used_count | int < containers_count | int"

    - name: "Generate list of containers we are going to use"
      ansible.builtin.shell: |
        awk 'NR > {{ containers_used_count | int }} && NR <= {{ containers_used_count | int + size | int }} {print $NF}' \
          /root/container-ips.shuffled \
          >clients.ini

    - name: "Set base log name"
      ansible.builtin.set_fact:
        clients_yaml_cmd_base: "/root/out-{{ lookup('pipe', 'date --utc --iso-8601=seconds') | regex_replace('[^A-Za-z0-9-]', '_') }}"
      run_once: true

    - name: "Set log name"
      ansible.builtin.set_fact:
        clients_yaml_cmd_log: "{{ clients_yaml_cmd_base }}.log"
      run_once: true

    - name: "Download host registration script from Satellite"
      ansible.builtin.get_url:
        url: http://{{ groups['satellite6'] | first }}/pub/host-registration_{{ tests_registration_target }}.sh
        dest: /root/clients_host-registration.sh
        mode: '0400'
      when: "method == 'clients_host-registration'"

    - name: "Run clients_host-registration.yaml (log = {{ clients_yaml_cmd_log }})"
      shell: |
        ansible-playbook \
          --private-key /root/id_rsa_key \
          --forks "{{ size }}" \
          -i clients.ini \
          clients_host-registration.yaml \
          &> "{{ clients_yaml_cmd_log }}"
      register: clients_yaml_cmd
      ignore_errors: true
      when: "method == 'clients_host-registration'"

    - name: "Run clients.yaml (log = {{ clients_yaml_cmd_log }})"
      shell: |
        ansible-playbook \
          --private-key /root/id_rsa_key \
          --forks "{{ size }}" \
          -i clients.ini \
          -e "server={{ groups['satellite6']|first }}" \
          -e "activationkey='ActivationKey'" \
          -e "organization='{{ sat_orglabel }}'" \
          -e "config_server_server_timeout='{{ config_server_server_timeout|default('') }}'" \
          clients.yaml \
          &> "{{ clients_yaml_cmd_log }}"
      register: clients_yaml_cmd
      ignore_errors: true
      when:
        - method == 'clients.yaml'
        - hostvars[groups['satellite6']|first].rex_mode is not defined or hostvars[groups['satellite6']|first].rex_mode == 'ssh'

    - name: "Run clients.yaml (log = {{ clients_yaml_cmd_log }})"
      shell: |
        ansible-playbook \
          --private-key /root/id_rsa_key \
          --forks "{{ size }}" \
          -i clients.ini \
          -e "server={{ groups['satellite6']|first }}" \
          -e "activationkey='ActivationKey'" \
          -e "organization='{{ sat_orglabel }}'" \
          -e "config_server_server_timeout='{{ config_server_server_timeout|default('') }}'" \
          -e "rex_mode='mqtt'" \
          clients.yaml \
          &> "{{ clients_yaml_cmd_log }}"
      register: clients_yaml_cmd
      ignore_errors: true
      when:
        - method == 'clients.yaml'
        - hostvars[groups['satellite6']|first].rex_mode is defined and hostvars[groups['satellite6']|first].rex_mode == 'mqtt'

    - name: "Run clients-register.yaml (log = {{ clients_yaml_cmd_log }})"
      shell: |
        ansible-playbook \
          --private-key /root/id_rsa_key \
          --forks "{{ size }}" \
          -i clients.ini \
          -e "server={{ groups['satellite6']|first }}" \
          -e "sat_user={{ sat_user }}" \
          -e "sat_pass={{ sat_pass }}" \
          -e "activationkey='ActivationKey'" \
          -e "organization='{{ sat_orglabel }}'" \
          clients-register.yaml \
          &> "{{ clients_yaml_cmd_log }}"
      register: clients_yaml_cmd
      ignore_errors: true
      when: "method == 'clients-register.yaml'"

    - name: "Run clients-bootstrap.yaml (log = {{ clients_yaml_cmd_log }})"
      shell: |
        ansible-playbook \
          --private-key /root/id_rsa_key \
          --forks "{{ size }}" \
          -i clients.ini \
          -e "server={{ groups['satellite6']|first }}" \
          -e "user={{ sat_user }}" \
          -e "pass={{ sat_pass }}" \
          -e "activationkey='ActivationKey'" \
          -e "organization='{{ sat_org }}'" \
          -e "location='{{ sat_location }}'" \
          -e "hostgroup='{{ registration_hostgroup }}'" \
          clients-bootstrap.yaml \
          &> "{{ clients_yaml_cmd_log }}"
      register: clients_yaml_cmd
      ignore_errors: true
      when: "method == 'clients-bootstrap.yaml'"

    - name: "Fetch client logs"
      fetch:
        src: "{{ clients_yaml_cmd_log }}"
        dest: "{{ registration_logs }}"
      ignore_errors: true

    - name: "Get how long registration took"
      shell:
        grep '"msg". "Register' "{{ clients_yaml_cmd_log }}" | cut -d '"' -f 4
      register: clients_yaml_grepper_timings

    - name: "Append registration timings to central list"
      set_fact:
        grepper_times: "{{ grepper_times|default([]) + hostvars[item]['clients_yaml_grepper_timings']['stdout_lines'] }}"
      with_items: "{{ ansible_play_batch }}"
      run_once: true

    - name: "Show how long registration took"
      debug:
        var: grepper_times
      run_once: true

    - name: "Show number of successful registration events"
      debug:
        var: grepper_times|length
      run_once: true

    - name: "Increment number of already registered containers"
      lineinfile:
        path: /root/container-used-count
        regexp: .*
        line: "{{ containers_used_count|int + size|int }}"
        create: yes

    - name: "Get number of hosts that failed to register"
      ansible.builtin.command:
        cmd: "grep -c '^fatal: ' {{ clients_yaml_cmd_log }}"
      register: num_failed_hosts
      failed_when: num_failed_hosts.rc == 2

    - name: "Show number of hosts that failed to register"
      ansible.builtin.debug:
        var: num_failed_hosts.stdout_lines

    - name: "Set additional retries log name (if needed)"
      ansible.builtin.set_fact:
        clients_yaml_cmd_retries_log: "{{ clients_yaml_cmd_base }}-retries.log"
      when:
        - num_failed_hosts.stdout_lines[0] | int > 0
        - method == 'clients_host-registration'

    - name: "Try to re-register failed hosts (if needed)"
      ansible.builtin.shell: |
        cp -p {{ clients_yaml_cmd_log }} {{ clients_yaml_cmd_retries_log }}

        while (( "$(grep -c '^fatal: ' {{ clients_yaml_cmd_retries_log }})" != 0 )); do
          unset CLIENT_IP_LIST

          for client_ip in $(awk '/^fatal: / {print $2}' {{ clients_yaml_cmd_retries_log }} | cut -d'[' -f2 | cut -d']' -f1); do
            CLIENT_IP_LIST+="$client_ip,"
          done

          ansible-playbook \
           --private-key /root/id_rsa_key \
           --inventory $CLIENT_IP_LIST \
           --forks "{{ num_retry_forks }}" \
           clients_host-registration.yaml \
           &> "{{ clients_yaml_cmd_retries_log }}"
        done
      register: clients_yaml_cmd_retries
      ignore_errors: true
      when:
        - num_failed_hosts.stdout_lines[0] | int > 0
        - method == 'clients_host-registration'

    - name: "Give server some time to rest"
      pause:
        seconds: "{{ resting }}"
...
